name: Deploy to GKE

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build and Deploy to GKE
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code from barista-app-docker repository
      uses: actions/checkout@v3
      with:
        repository: shonevarkey/barista-app-docker
        ref: main

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        version: 'latest'
        project_id: ${{ vars.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}

    - name: Authenticate Docker with Google Container Registry
      run: |
          echo "${{ secrets.GCP_SA_KEY }}" | gcloud auth activate-service-account --key-file=-
          gcloud auth configure-docker gcr.io

    - name: Build and Push Docker Image with Commit Hash Tagging
      run: |
        IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-7)
        docker build -t gcr.io/${{ vars.GCP_PROJECT_ID }}/coffee-shop:$IMAGE_TAG .
        docker push gcr.io/${{ vars.GCP_PROJECT_ID }}/coffee-shop:$IMAGE_TAG
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    - name: Configure kubectl
      uses: google-github-actions/get-gke-credentials@v1
      with:
        cluster_name: ${{ vars.GKE_CLUSTER_NAME }}
        location: ${{ vars.GKE_CLUSTER_REGION }}

    - name: Update Image Tag in Kubernetes Manifest
      run: |
        sed -i "s|gcr.io/${{ vars.GCP_PROJECT_ID }}/coffee-shop:latest|gcr.io/${{ vars.GCP_PROJECT_ID }}/coffee-shop:$IMAGE_TAG|g" kubernetes-manifests/k8s-manifests.yaml

    - name: Deploy to GKE
      run: |
        echo "Deploying to GKE..."
        kubectl apply -f kubernetes-manifests/k8s-manifests.yaml
        kubectl rollout status deployment/coffee-shop
